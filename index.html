<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ludo Cash - Advanced Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 pb-20">
    <!-- TOP BAR -->
    <div class="bg-blue-600 text-white p-4 flex justify-between shadow-lg sticky top-0 z-50">
        <h1 class="font-bold">LUDO PRO</h1>
        <div class="text-right">
            <p class="text-[10px]">ব্যালেন্স</p>
            <p class="font-bold">৳ <span id="balance">0</span></p>
        </div>
    </div>

    <!-- TABS CONTAINER -->
    <div id="game-tab" class="tab-content block p-4">
        <div class="bg-white p-10 rounded-xl shadow text-center">গেম বোর্ড এখানে আসবে...</div>
    </div>

    <!-- WALLET TAB -->
    <div id="wallet-tab" class="tab-content hidden p-4">
        <div class="space-y-4">
            <!-- Deposit Section -->
            <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-pink-500">
                <h3 class="font-bold text-pink-600 mb-2">টাকা জমা দিন (Deposit)</h3>
                <div class="bg-gray-100 p-3 rounded mb-3 text-center">
                    <p class="text-xs">বিকাশ পার্সোনাল নাম্বার:</p>
                    <p id="display-bikash" class="font-bold text-lg">Loading...</p>
                </div>
                <input type="number" id="dep-amount" placeholder="পরিমাণ" class="w-full border p-2 rounded mb-2">
                <input type="text" id="dep-trx" placeholder="TrxID" class="w-full border p-2 rounded mb-2">
                <button onclick="handleMoney('deposit')" class="w-full bg-pink-600 text-white py-2 rounded font-bold">ডিপোজিট রিকোয়েস্ট</button>
            </div>

            <!-- Withdraw Section -->
            <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500">
                <h3 class="font-bold text-blue-600 mb-2">টাকা তুলুন (Withdraw)</h3>
                <input type="number" id="wit-amount" placeholder="পরিমাণ" class="w-full border p-2 rounded mb-2">
                <input type="text" id="wit-phone" placeholder="বিকাশ নাম্বার (যেখানে টাকা নিবেন)" class="w-full border p-2 rounded mb-2">
                <button onclick="handleMoney('withdraw')" class="w-full bg-blue-600 text-white py-2 rounded font-bold">উইথড্র রিকোয়েস্ট</button>
            </div>
        </div>
    </div>

    <!-- ADMIN TAB -->
    <div id="admin-tab" class="tab-content hidden p-4">
        <!-- Settings -->
        <div class="bg-black text-white p-4 rounded-xl mb-6">
            <h3 class="text-sm font-bold mb-2">সেটিংস (বিকাশ নাম্বার সেট করুন)</h3>
            <div class="flex gap-2">
                <input type="text" id="admin-bikash-input" class="text-black p-2 rounded flex-1" placeholder="New bKash Number">
                <button onclick="updateSettings()" class="bg-yellow-500 text-black px-4 py-2 rounded font-bold">Update</button>
            </div>
        </div>

        <h3 class="font-bold mb-4 text-red-600">পেন্ডিং রিকোয়েস্ট লিস্ট:</h3>
        <div id="admin-list" class="space-y-3"></div>
    </div>

    <!-- FOOTER NAV -->
    <div class="fixed bottom-0 w-full bg-white border-t flex justify-around p-3 shadow-lg">
        <button onclick="showTab('game-tab')">Play</button>
        <button onclick="showTab('wallet-tab')">Wallet</button>
        <button onclick="showTab('admin-tab')">Admin</button>
    </div>

    <script>
        const userId = "shahin_user_1";
        let isAdmin = false;

        // গেম লোড হলে ডাটা আনা
        async function init() {
            loadBalance();
            const res = await fetch('/api/wallet?type=settings');
            const data = await res.json();
            document.getElementById('display-bikash').innerText = data.bikash;
            document.getElementById('admin-bikash-input').value = data.bikash;
        }

        async function loadBalance() {
            const res = await fetch(`/api/wallet?userId=${userId}`);
            const data = await res.json();
            document.getElementById('balance').innerText = data.balance || 0;
        }

        async function handleMoney(type) {
            const amount = document.getElementById(type === 'deposit' ? 'dep-amount' : 'wit-amount').value;
            const trxId = document.getElementById('dep-trx').value;
            const phone = document.getElementById('wit-phone').value;

            if(!amount) return alert("পরিমাণ লিখুন");

            const res = await fetch('/api/wallet', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type, userId, amount, trxId, phone })
            });
            
            if(res.ok) {
                alert("রিকোয়েস্ট সফল হয়েছে!");
                loadBalance();
            } else {
                alert("ব্যালেন্স কম অথবা সমস্যা হয়েছে।");
            }
        }

        async function updateSettings() {
            const num = document.getElementById('admin-bikash-input').value;
            await fetch('/api/wallet', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type: 'updateSettings', bikash: num })
            });
            alert("নাম্বার আপডেট হয়েছে!");
            init();
        }

        async function loadAdmin() {
            const res = await fetch('/api/wallet?admin=true');
            const list = await res.json();
            const div = document.getElementById('admin-list');
            div.innerHTML = list.map(r => `
                <div class="bg-white p-3 rounded shadow border-l-4 ${r.type==='deposit'?'border-pink-500':'border-blue-500'}">
                    <p class="text-xs font-bold text-gray-400 uppercase">${r.type}</p>
                    <p class="font-bold">৳${r.amount} (${r.userId})</p>
                    <p class="text-[10px] text-gray-500">TrxID/Phone: ${r.type==='deposit'?r.trxId:r.phone}</p>
                    <div class="flex gap-2 mt-2">
                        <button onclick="adminAction('${r._id}', '${r.userId}', ${r.amount}, 'approve', '${r.type}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Approve</button>
                        <button onclick="adminAction('${r._id}', '${r.userId}', ${r.amount}, 'reject', '${r.type}')" class="bg-red-600 text-white px-3 py-1 rounded text-xs">Cancel/Reject</button>
                    </div>
                </div>
            `).join('');
        }

        async function adminAction(id, userId, amount, action, type) {
            await fetch('/api/wallet', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action, id, userId, amount, type })
            });
            loadAdmin();
            loadBalance();
        }

        function showTab(id) {
            if(id === 'admin-tab' && !isAdmin) {
                const pin = prompt("Admin Pin:");
                if(pin === "2025") isAdmin = true;
                else return;
            }
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'admin-tab') loadAdmin();
        }

        init();
    </script>
</body>
</html>
